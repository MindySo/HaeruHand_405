<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>카카오 로그인 처리 중...</title>
</head>
<body>
<p>로그인 처리 중입니다...</p>

<script>
  (async () => {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');

    if (code) {
      console.log('인가코드:', code);

      try {
        const response = await fetch(
                'http://localhost:8080/v1/user/issue/kakao',
                // 'http://i13a405.p.ssafy.io/api/v1/user/issue/kakao',
                {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ code }),
                  credentials: 'include',
                }
        );

        // const result = await response.json();
        // console.log('서버 응답:', result);

        // 헤더에서 토큰 꺼내기
        const accessToken = response.headers.get('Authorization')?.replace('Bearer ', '');
        const refreshToken = response.headers.get('X-Refresh-Token');

        // 응답 바디 파싱
        const result = await response.json();

        if (result.is_success) {
          alert('로그인 성공!');

          // 여기서 accessToken 및 유저 정보 처리 가능
          sessionStorage.setItem('accessToken', accessToken);
          sessionStorage.setItem('refreshToken', refreshToken);
          sessionStorage.setItem('userInfo', JSON.stringify(result.data.user));
          sessionStorage.setItem('accessTokenExpiresIn', result.data.accessTokenExpiresIn);

          window.location.href = '/success.html';
        } else {
          alert('로그인 실패: ' + result.message);
        }
      } catch (err) {
        console.error('로그인 요청 에러:', err);
        alert('로그인 중 오류가 발생했습니다.');
      }
    } else {
      alert('인가코드 없음!');
    }
  })();
</script>
</body>
</html>
