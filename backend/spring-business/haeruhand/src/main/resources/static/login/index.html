<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>카카오 로그인 테스트</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .container {
        background: white;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 400px;
        width: 100%;
      }
      h1 {
        color: #333;
        margin-bottom: 30px;
      }
      .kakao-btn {
        background-color: #fee500;
        border: none;
        padding: 14px 28px;
        font-size: 16px;
        font-weight: 600;
        color: #000000;
        cursor: pointer;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        transition: transform 0.2s;
        text-decoration: none;
      }
      .kakao-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .kakao-icon {
        width: 20px;
        height: 20px;
      }
      .divider {
        margin: 30px 0;
        color: #999;
        font-size: 14px;
      }
      .test-section {
        margin-top: 30px;
        padding-top: 30px;
        border-top: 1px solid #eee;
      }
      .test-section h3 {
        color: #666;
        font-size: 16px;
        margin-bottom: 20px;
      }
      .test-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
        transition: background 0.2s;
      }
      .test-btn:hover {
        background: #5a67d8;
      }
      .response {
        margin-top: 20px;
        padding: 15px;
        background: #f7f7f7;
        border-radius: 8px;
        text-align: left;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        display: none;
      }
      .response.show {
        display: block;
      }
      .user-info {
        display: none;
        margin-top: 20px;
        padding: 20px;
        background: #f0f8ff;
        border-radius: 8px;
      }
      .user-info.show {
        display: block;
      }
      .user-info img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin-bottom: 10px;
      }
      .token-info {
        display: none;
        margin-top: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 8px;
        text-align: left;
        font-size: 12px;
      }
      .token-info.show {
        display: block;
      }
      .token-item {
        margin-bottom: 15px;
        padding: 10px;
        background: white;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
      .token-label {
        font-weight: bold;
        color: #667eea;
        margin-bottom: 5px;
      }
      .token-value {
        word-break: break-all;
        font-family: 'Courier New', monospace;
        font-size: 11px;
        background: #f9f9f9;
        padding: 8px;
        border-radius: 3px;
        user-select: text;
        cursor: text;
      }
      .copy-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        margin-top: 5px;
      }
      .copy-btn:hover {
        background: #5a67d8;
      }
      .status {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        display: inline-block;
        margin-top: 10px;
      }
      .status.success {
        background: #10b981;
        color: white;
      }
      .status.error {
        background: #ef4444;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🔐 해루한디 로그인</h1>

      <a href="#" id="kakaoLoginBtn" class="kakao-btn">
        <svg class="kakao-icon" viewBox="0 0 24 24">
          <path
            d="M12 3c5.514 0 10 3.476 10 7.747 0 4.272-4.48 7.748-9.986 7.748-.62 0-1.092-.046-1.759-.097-1 .776-1.774 1.403-3.485 1.962.26-1.383-.113-2.259-.514-3.259-2.383-1.505-4.256-3.411-4.256-6.354 0-4.271 4.486-7.747 10-7.747z"
          />
        </svg>
        카카오 로그인
      </a>

      <div class="test-section">
        <h3>테스트 도구</h3>
        <button class="test-btn" onclick="getUserInfo()">
          사용자 정보 조회
        </button>
        <button class="test-btn" onclick="refreshToken()">토큰 갱신</button>
        <button class="test-btn" onclick="clearTokens()">토큰 초기화</button>
        <button
          class="test-btn"
          onclick="goToWebSocketTest()"
          style="background: #10b981"
        >
          웹소켓 테스트
        </button>

        <div id="userInfo" class="user-info"></div>
        <div id="tokenInfo" class="token-info">
          <h3 style="color: #667eea; margin-bottom: 15px">
            🔑 토큰 정보 (개발용)
          </h3>
          <div class="token-item">
            <div class="token-label">Access Token:</div>
            <div id="accessTokenDisplay" class="token-value">-</div>
            <button class="copy-btn" onclick="copyToken('access')">
              📋 복사
            </button>
          </div>
          <div class="token-item">
            <div class="token-label">Refresh Token:</div>
            <div id="refreshTokenDisplay" class="token-value">-</div>
            <button class="copy-btn" onclick="copyToken('refresh')">
              📋 복사
            </button>
          </div>
        </div>
        <div id="response" class="response"></div>
      </div>
    </div>

    <script>
      // ===== 환경 설정 =====
      const KAKAO_CLIENT_ID = '434231d018b4c369436c39181c2be5e3';
      const REDIRECT_URI = 'http://localhost:5173/login'; // 로컬 테스트용 (Python 서버 5173 포트)

      // 환경별 API URL (사용할 환경의 주석을 해제하세요)
      // const BACKEND_URL = 'http://localhost:8080';                    // 🔧 로컬 개발서버
      const BACKEND_URL = 'https://haeruhand.o-r.kr/api'; // 🌐 운영서버

      // ===== 저장소 키 =====
      const STORAGE_KEYS = {
        ACCESS_TOKEN: 'accessToken',
        REFRESH_TOKEN: 'refreshToken',
        USER_INFO: 'userInfo',
      };

      // ===== 카카오 로그인 처리 =====
      document
        .getElementById('kakaoLoginBtn')
        .addEventListener('click', function (e) {
          e.preventDefault();
          const kakaoAuthUrl = `https://kauth.kakao.com/oauth/authorize?client_id=${KAKAO_CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=code`;
          window.location.href = kakaoAuthUrl;
        });

      // ===== 초기화 =====
      window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (code) {
          handleKakaoCallback(code); // 카카오 콜백 처리
        } else {
          checkLoginStatus(); // 로그인 상태 확인
        }
      };

      // ===== 로그인 상태 관리 =====
      function checkLoginStatus() {
        const accessToken = localStorage.getItem(STORAGE_KEYS.ACCESS_TOKEN);
        if (accessToken) {
          showStatus('로그인 상태', 'success');
          displayStoredUserInfo();
          displayTokenInfo(); // 토큰 정보 표시
        }
      }

      function displayStoredUserInfo() {
        const userInfo = localStorage.getItem(STORAGE_KEYS.USER_INFO);
        if (userInfo) {
          const user = JSON.parse(userInfo);
          document.getElementById('userInfo').innerHTML = `
                    <img src="${user.profileImageUrl}" alt="프로필">
                    <h4>${user.nickname}</h4>
                    <p>User ID: ${user.userId}</p>
                    <p>Kakao ID: ${user.kakaoSub}</p>
                `;
          document.getElementById('userInfo').classList.add('show');
        }
      }

      function displayTokenInfo() {
        const accessToken = localStorage.getItem(STORAGE_KEYS.ACCESS_TOKEN);
        const refreshToken = localStorage.getItem(STORAGE_KEYS.REFRESH_TOKEN);

        if (accessToken || refreshToken) {
          document.getElementById('accessTokenDisplay').textContent =
            accessToken || '-';
          document.getElementById('refreshTokenDisplay').textContent =
            refreshToken || '-';
          document.getElementById('tokenInfo').classList.add('show');
        }
      }

      function copyToken(type) {
        let token = '';
        let message = '';

        if (type === 'access') {
          token = localStorage.getItem(STORAGE_KEYS.ACCESS_TOKEN);
          message = 'Access Token 복사됨';
        } else if (type === 'refresh') {
          token = localStorage.getItem(STORAGE_KEYS.REFRESH_TOKEN);
          message = 'Refresh Token 복사됨';
        }

        if (token) {
          navigator.clipboard
            .writeText(token)
            .then(() => {
              showStatus(message, 'success');
            })
            .catch(() => {
              // 클립보드 API가 지원되지 않는 경우 대체 방법
              const textarea = document.createElement('textarea');
              textarea.value = token;
              document.body.appendChild(textarea);
              textarea.select();
              document.execCommand('copy');
              document.body.removeChild(textarea);
              showStatus(message, 'success');
            });
        }
      }

      // ===== API 호출 함수 =====
      async function getUserInfo() {
        const accessToken = localStorage.getItem(STORAGE_KEYS.ACCESS_TOKEN);
        if (!accessToken) {
          showResponse({ error: '로그인이 필요합니다.' });
          return;
        }

        try {
          const response = await fetch(`${BACKEND_URL}/v1/user/userinfo`, {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          const data = await response.json();
          if (data.success) {
            localStorage.setItem(
              STORAGE_KEYS.USER_INFO,
              JSON.stringify(data.data)
            );
            displayStoredUserInfo();
            showResponse(data);
            showStatus('사용자 정보 조회 성공', 'success');
          } else {
            showResponse(data);
            showStatus('사용자 정보 조회 실패', 'error');
          }
        } catch (error) {
          showResponse({ error: error.message });
          showStatus('요청 실패', 'error');
        }
      }

      async function refreshToken() {
        const refreshToken = localStorage.getItem(STORAGE_KEYS.REFRESH_TOKEN);
        if (!refreshToken) {
          showResponse({ error: '리프레시 토큰이 없습니다.' });
          return;
        }

        try {
          const response = await fetch(`${BACKEND_URL}/v1/user/reissue`, {
            method: 'POST',
            headers: {
              'X-Refresh-Token': refreshToken,
            },
          });

          const data = await response.json();
          if (data.is_success) {
            // 새 토큰 저장
            if (response.headers.get('Authorization')) {
              localStorage.setItem(
                STORAGE_KEYS.ACCESS_TOKEN,
                response.headers.get('Authorization').replace('Bearer ', '')
              );
            }
            if (response.headers.get('X-Refresh-Token')) {
              localStorage.setItem(
                STORAGE_KEYS.REFRESH_TOKEN,
                response.headers.get('X-Refresh-Token')
              );
            }
            showResponse(data);
            showStatus('토큰 갱신 성공', 'success');
          } else {
            showResponse(data);
            showStatus('토큰 갱신 실패', 'error');
          }
        } catch (error) {
          showResponse({ error: error.message });
          showStatus('요청 실패', 'error');
        }
      }

      function clearTokens() {
        localStorage.removeItem(STORAGE_KEYS.ACCESS_TOKEN);
        localStorage.removeItem(STORAGE_KEYS.REFRESH_TOKEN);
        localStorage.removeItem(STORAGE_KEYS.USER_INFO);
        document.getElementById('userInfo').classList.remove('show');
        document.getElementById('tokenInfo').classList.remove('show'); // 토큰 정보 숨김
        showResponse({ message: '토큰이 초기화되었습니다.' });
        showStatus('로그아웃 완료', 'success');
      }

      // ===== UI 헬퍼 함수 =====
      function showResponse(data) {
        const responseDiv = document.getElementById('response');
        responseDiv.textContent = JSON.stringify(data, null, 2);
        responseDiv.classList.add('show');
      }

      function showStatus(message, type) {
        const existingStatus = document.querySelector('.status');
        if (existingStatus) {
          existingStatus.remove();
        }

        const status = document.createElement('div');
        status.className = `status ${type}`;
        status.textContent = message;
        document.querySelector('.container').appendChild(status);

        setTimeout(() => {
          status.remove();
        }, 3000);
      }

      function goToWebSocketTest() {
        const accessToken = localStorage.getItem(STORAGE_KEYS.ACCESS_TOKEN);
        if (!accessToken) {
          showStatus('먼저 로그인해주세요', 'error');
          return;
        }
        window.location.href = 'websocket-test.html';
      }

      // ===== 카카오 콜백 처리 =====
      async function handleKakaoCallback(authCode) {
        try {
          showStatus('로그인 처리 중...', 'success');

          // 백엔드로 인증 코드 전송
          const response = await fetch(`${BACKEND_URL}/v1/user/issue/kakao`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ code: authCode }),
          });

          // 응답 헤더에서 토큰 추출
          const accessToken = response.headers.get('Authorization');
          const refreshToken = response.headers.get('X-Refresh-Token');

          const data = await response.json();

          // ApiResponse의 is_success 필드 확인
          if (data.is_success && (accessToken || refreshToken)) {
            // 토큰 저장
            if (accessToken) {
              localStorage.setItem(
                STORAGE_KEYS.ACCESS_TOKEN,
                accessToken.replace('Bearer ', '')
              );
            }
            if (refreshToken) {
              localStorage.setItem(STORAGE_KEYS.REFRESH_TOKEN, refreshToken);
            }

            // 사용자 정보 저장
            if (data.data && data.data.user) {
              localStorage.setItem(
                STORAGE_KEYS.USER_INFO,
                JSON.stringify(data.data.user)
              );
            }

            showStatus('로그인 성공!', 'success');

            // URL에서 code 파라미터 제거 및 페이지 새로고침
            window.history.replaceState(
              {},
              document.title,
              window.location.pathname
            );
            checkLoginStatus();
            displayTokenInfo(); // 토큰 정보 즉시 표시
          } else {
            throw new Error(data.message || '로그인 처리 실패');
          }
        } catch (error) {
          console.error('Login error:', error);
          showStatus(`로그인 실패: ${error.message}`, 'error');
        }
      }
    </script>
  </body>
</html>
