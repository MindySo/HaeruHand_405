<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .container {
        background: white;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 400px;
        width: 100%;
      }
      h1 {
        color: #333;
        margin-bottom: 30px;
      }
      .kakao-btn {
        background-color: #fee500;
        border: none;
        padding: 14px 28px;
        font-size: 16px;
        font-weight: 600;
        color: #000000;
        cursor: pointer;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        transition: transform 0.2s;
        text-decoration: none;
      }
      .kakao-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .kakao-icon {
        width: 20px;
        height: 20px;
      }
      .divider {
        margin: 30px 0;
        color: #999;
        font-size: 14px;
      }
      .test-section {
        margin-top: 30px;
        padding-top: 30px;
        border-top: 1px solid #eee;
      }
      .test-section h3 {
        color: #666;
        font-size: 16px;
        margin-bottom: 20px;
      }
      .test-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
        transition: background 0.2s;
      }
      .test-btn:hover {
        background: #5a67d8;
      }
      .response {
        margin-top: 20px;
        padding: 15px;
        background: #f7f7f7;
        border-radius: 8px;
        text-align: left;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        display: none;
      }
      .response.show {
        display: block;
      }
      .user-info {
        display: none;
        margin-top: 20px;
        padding: 20px;
        background: #f0f8ff;
        border-radius: 8px;
      }
      .user-info.show {
        display: block;
      }
      .user-info img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin-bottom: 10px;
      }
      .token-info {
        display: none;
        margin-top: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 8px;
        text-align: left;
        font-size: 12px;
      }
      .token-info.show {
        display: block;
      }
      .token-item {
        margin-bottom: 15px;
        padding: 10px;
        background: white;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
      .token-label {
        font-weight: bold;
        color: #667eea;
        margin-bottom: 5px;
      }
      .token-value {
        word-break: break-all;
        font-family: 'Courier New', monospace;
        font-size: 11px;
        background: #f9f9f9;
        padding: 8px;
        border-radius: 3px;
        user-select: text;
        cursor: text;
      }
      .copy-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        margin-top: 5px;
      }
      .copy-btn:hover {
        background: #5a67d8;
      }
      .status {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        display: inline-block;
        margin-top: 10px;
      }
      .status.success {
        background: #10b981;
        color: white;
      }
      .status.error {
        background: #ef4444;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ” í•´ë£¨í•œë”” ë¡œê·¸ì¸</h1>

      <a href="#" id="kakaoLoginBtn" class="kakao-btn">
        <svg class="kakao-icon" viewBox="0 0 24 24">
          <path
            d="M12 3c5.514 0 10 3.476 10 7.747 0 4.272-4.48 7.748-9.986 7.748-.62 0-1.092-.046-1.759-.097-1 .776-1.774 1.403-3.485 1.962.26-1.383-.113-2.259-.514-3.259-2.383-1.505-4.256-3.411-4.256-6.354 0-4.271 4.486-7.747 10-7.747z"
          />
        </svg>
        ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
      </a>

      <div class="test-section">
        <h3>í…ŒìŠ¤íŠ¸ ë„êµ¬</h3>
        <button class="test-btn" onclick="getUserInfo()">
          ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
        </button>
        <button class="test-btn" onclick="refreshToken()">í† í° ê°±ì‹ </button>
        <button class="test-btn" onclick="clearTokens()">í† í° ì´ˆê¸°í™”</button>
        <button
          class="test-btn"
          onclick="goToWebSocketTest()"
          style="background: #10b981"
        >
          ì›¹ì†Œì¼“ í…ŒìŠ¤íŠ¸
        </button>

        <div id="userInfo" class="user-info"></div>
        <div id="tokenInfo" class="token-info">
          <h3 style="color: #667eea; margin-bottom: 15px">
            ğŸ”‘ í† í° ì •ë³´ (ê°œë°œìš©)
          </h3>
          <div class="token-item">
            <div class="token-label">Access Token:</div>
            <div id="accessTokenDisplay" class="token-value">-</div>
            <button class="copy-btn" onclick="copyToken('access')">
              ğŸ“‹ ë³µì‚¬
            </button>
          </div>
          <div class="token-item">
            <div class="token-label">Refresh Token:</div>
            <div id="refreshTokenDisplay" class="token-value">-</div>
            <button class="copy-btn" onclick="copyToken('refresh')">
              ğŸ“‹ ë³µì‚¬
            </button>
          </div>
        </div>
        <div id="response" class="response"></div>
      </div>
    </div>

    <script>
      // ===== í™˜ê²½ ì„¤ì • =====
      const KAKAO_CLIENT_ID = '434231d018b4c369436c39181c2be5e3';
      const REDIRECT_URI = 'http://localhost:5173/login'; // ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© (Python ì„œë²„ 5173 í¬íŠ¸)

      // í™˜ê²½ë³„ API URL (ì‚¬ìš©í•  í™˜ê²½ì˜ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš”)
      // const BACKEND_URL = 'http://localhost:8080';                    // ğŸ”§ ë¡œì»¬ ê°œë°œì„œë²„
      const BACKEND_URL = 'https://haeruhand.o-r.kr/api'; // ğŸŒ ìš´ì˜ì„œë²„

      // ===== ì €ì¥ì†Œ í‚¤ =====
      const STORAGE_KEYS = {
        ACCESS_TOKEN: 'accessToken',
        REFRESH_TOKEN: 'refreshToken',
        USER_INFO: 'userInfo',
      };

      // ===== ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì²˜ë¦¬ =====
      document
        .getElementById('kakaoLoginBtn')
        .addEventListener('click', function (e) {
          e.preventDefault();
          const kakaoAuthUrl = `https://kauth.kakao.com/oauth/authorize?client_id=${KAKAO_CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=code`;
          window.location.href = kakaoAuthUrl;
        });

      // ===== ì´ˆê¸°í™” =====
      window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (code) {
          handleKakaoCallback(code); // ì¹´ì¹´ì˜¤ ì½œë°± ì²˜ë¦¬
        } else {
          checkLoginStatus(); // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        }
      };

      // ===== ë¡œê·¸ì¸ ìƒíƒœ ê´€ë¦¬ =====
      function checkLoginStatus() {
        const accessToken = localStorage.getItem(STORAGE_KEYS.ACCESS_TOKEN);
        if (accessToken) {
          showStatus('ë¡œê·¸ì¸ ìƒíƒœ', 'success');
          displayStoredUserInfo();
          displayTokenInfo(); // í† í° ì •ë³´ í‘œì‹œ
        }
      }

      function displayStoredUserInfo() {
        const userInfo = localStorage.getItem(STORAGE_KEYS.USER_INFO);
        if (userInfo) {
          const user = JSON.parse(userInfo);
          document.getElementById('userInfo').innerHTML = `
                    <img src="${user.profileImageUrl}" alt="í”„ë¡œí•„">
                    <h4>${user.nickname}</h4>
                    <p>User ID: ${user.userId}</p>
                    <p>Kakao ID: ${user.kakaoSub}</p>
                `;
          document.getElementById('userInfo').classList.add('show');
        }
      }

      function displayTokenInfo() {
        const accessToken = localStorage.getItem(STORAGE_KEYS.ACCESS_TOKEN);
        const refreshToken = localStorage.getItem(STORAGE_KEYS.REFRESH_TOKEN);

        if (accessToken || refreshToken) {
          document.getElementById('accessTokenDisplay').textContent =
            accessToken || '-';
          document.getElementById('refreshTokenDisplay').textContent =
            refreshToken || '-';
          document.getElementById('tokenInfo').classList.add('show');
        }
      }

      function copyToken(type) {
        let token = '';
        let message = '';

        if (type === 'access') {
          token = localStorage.getItem(STORAGE_KEYS.ACCESS_TOKEN);
          message = 'Access Token ë³µì‚¬ë¨';
        } else if (type === 'refresh') {
          token = localStorage.getItem(STORAGE_KEYS.REFRESH_TOKEN);
          message = 'Refresh Token ë³µì‚¬ë¨';
        }

        if (token) {
          navigator.clipboard
            .writeText(token)
            .then(() => {
              showStatus(message, 'success');
            })
            .catch(() => {
              // í´ë¦½ë³´ë“œ APIê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²½ìš° ëŒ€ì²´ ë°©ë²•
              const textarea = document.createElement('textarea');
              textarea.value = token;
              document.body.appendChild(textarea);
              textarea.select();
              document.execCommand('copy');
              document.body.removeChild(textarea);
              showStatus(message, 'success');
            });
        }
      }

      // ===== API í˜¸ì¶œ í•¨ìˆ˜ =====
      async function getUserInfo() {
        const accessToken = localStorage.getItem(STORAGE_KEYS.ACCESS_TOKEN);
        if (!accessToken) {
          showResponse({ error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
          return;
        }

        try {
          const response = await fetch(`${BACKEND_URL}/v1/user/userinfo`, {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          const data = await response.json();
          if (data.success) {
            localStorage.setItem(
              STORAGE_KEYS.USER_INFO,
              JSON.stringify(data.data)
            );
            displayStoredUserInfo();
            showResponse(data);
            showStatus('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì„±ê³µ', 'success');
          } else {
            showResponse(data);
            showStatus('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨', 'error');
          }
        } catch (error) {
          showResponse({ error: error.message });
          showStatus('ìš”ì²­ ì‹¤íŒ¨', 'error');
        }
      }

      async function refreshToken() {
        const refreshToken = localStorage.getItem(STORAGE_KEYS.REFRESH_TOKEN);
        if (!refreshToken) {
          showResponse({ error: 'ë¦¬í”„ë ˆì‹œ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.' });
          return;
        }

        try {
          const response = await fetch(`${BACKEND_URL}/v1/user/reissue`, {
            method: 'POST',
            headers: {
              'X-Refresh-Token': refreshToken,
            },
          });

          const data = await response.json();
          if (data.is_success) {
            // ìƒˆ í† í° ì €ì¥
            if (response.headers.get('Authorization')) {
              localStorage.setItem(
                STORAGE_KEYS.ACCESS_TOKEN,
                response.headers.get('Authorization').replace('Bearer ', '')
              );
            }
            if (response.headers.get('X-Refresh-Token')) {
              localStorage.setItem(
                STORAGE_KEYS.REFRESH_TOKEN,
                response.headers.get('X-Refresh-Token')
              );
            }
            showResponse(data);
            showStatus('í† í° ê°±ì‹  ì„±ê³µ', 'success');
          } else {
            showResponse(data);
            showStatus('í† í° ê°±ì‹  ì‹¤íŒ¨', 'error');
          }
        } catch (error) {
          showResponse({ error: error.message });
          showStatus('ìš”ì²­ ì‹¤íŒ¨', 'error');
        }
      }

      function clearTokens() {
        localStorage.removeItem(STORAGE_KEYS.ACCESS_TOKEN);
        localStorage.removeItem(STORAGE_KEYS.REFRESH_TOKEN);
        localStorage.removeItem(STORAGE_KEYS.USER_INFO);
        document.getElementById('userInfo').classList.remove('show');
        document.getElementById('tokenInfo').classList.remove('show'); // í† í° ì •ë³´ ìˆ¨ê¹€
        showResponse({ message: 'í† í°ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' });
        showStatus('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'success');
      }

      // ===== UI í—¬í¼ í•¨ìˆ˜ =====
      function showResponse(data) {
        const responseDiv = document.getElementById('response');
        responseDiv.textContent = JSON.stringify(data, null, 2);
        responseDiv.classList.add('show');
      }

      function showStatus(message, type) {
        const existingStatus = document.querySelector('.status');
        if (existingStatus) {
          existingStatus.remove();
        }

        const status = document.createElement('div');
        status.className = `status ${type}`;
        status.textContent = message;
        document.querySelector('.container').appendChild(status);

        setTimeout(() => {
          status.remove();
        }, 3000);
      }

      function goToWebSocketTest() {
        const accessToken = localStorage.getItem(STORAGE_KEYS.ACCESS_TOKEN);
        if (!accessToken) {
          showStatus('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”', 'error');
          return;
        }
        window.location.href = 'websocket-test.html';
      }

      // ===== ì¹´ì¹´ì˜¤ ì½œë°± ì²˜ë¦¬ =====
      async function handleKakaoCallback(authCode) {
        try {
          showStatus('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...', 'success');

          // ë°±ì—”ë“œë¡œ ì¸ì¦ ì½”ë“œ ì „ì†¡
          const response = await fetch(`${BACKEND_URL}/v1/user/issue/kakao`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ code: authCode }),
          });

          // ì‘ë‹µ í—¤ë”ì—ì„œ í† í° ì¶”ì¶œ
          const accessToken = response.headers.get('Authorization');
          const refreshToken = response.headers.get('X-Refresh-Token');

          const data = await response.json();

          // ApiResponseì˜ is_success í•„ë“œ í™•ì¸
          if (data.is_success && (accessToken || refreshToken)) {
            // í† í° ì €ì¥
            if (accessToken) {
              localStorage.setItem(
                STORAGE_KEYS.ACCESS_TOKEN,
                accessToken.replace('Bearer ', '')
              );
            }
            if (refreshToken) {
              localStorage.setItem(STORAGE_KEYS.REFRESH_TOKEN, refreshToken);
            }

            // ì‚¬ìš©ì ì •ë³´ ì €ì¥
            if (data.data && data.data.user) {
              localStorage.setItem(
                STORAGE_KEYS.USER_INFO,
                JSON.stringify(data.data.user)
              );
            }

            showStatus('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');

            // URLì—ì„œ code íŒŒë¼ë¯¸í„° ì œê±° ë° í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            window.history.replaceState(
              {},
              document.title,
              window.location.pathname
            );
            checkLoginStatus();
            displayTokenInfo(); // í† í° ì •ë³´ ì¦‰ì‹œ í‘œì‹œ
          } else {
            throw new Error(data.message || 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì‹¤íŒ¨');
          }
        } catch (error) {
          console.error('Login error:', error);
          showStatus(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
      }
    </script>
  </body>
</html>
