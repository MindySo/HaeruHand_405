<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket ê°œë°œì í…ŒìŠ¤íŠ¸</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            line-height: 1.4;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: #2d2d30;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #3c3c3c;
        }
        
        .header h1 {
            font-size: 18px;
            color: #4fc1ff;
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-indicator.online { background: #4caf50; }
        .status-indicator.offline { background: #f44336; }
        
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100vh - 140px);
        }
        
        .panel {
            background: #2d2d30;
            border-radius: 6px;
            padding: 15px;
            border: 1px solid #3c3c3c;
            display: flex;
            flex-direction: column;
        }
        
        .panel h2 {
            font-size: 14px;
            color: #4fc1ff;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #3c3c3c;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            font-size: 11px;
            color: #9cdcfe;
            margin-bottom: 5px;
        }
        
        input, button {
            padding: 8px;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            font-family: inherit;
            font-size: 12px;
        }
        
        input {
            background: #1e1e1e;
            color: #d4d4d4;
            width: 100%;
        }
        
        input:focus {
            outline: none;
            border-color: #007acc;
        }
        
        button {
            background: #0e639c;
            color: white;
            cursor: pointer;
            border: none;
            margin: 2px;
        }
        
        button:hover:not(:disabled) {
            background: #1177bb;
        }
        
        button:disabled {
            background: #3c3c3c;
            color: #808080;
            cursor: not-allowed;
        }
        
        .btn-row {
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 6px 10px;
            font-size: 11px;
        }
        
        .messages-panel {
            display: flex;
            flex-direction: column;
        }
        
        .message-log {
            flex: 1;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Consolas', monospace;
            font-size: 11px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .message-entry {
            margin-bottom: 8px;
            padding: 4px;
            border-left: 3px solid transparent;
        }
        
        .message-entry.pub { border-left-color: #ffa500; color: #ffcc99; }
        .message-entry.sub { border-left-color: #4caf50; color: #c8e6c9; }
        .message-entry.connect { border-left-color: #2196f3; color: #bbdefb; }
        .message-entry.error { border-left-color: #f44336; color: #ffcdd2; }
        .message-entry.info { border-left-color: #9c27b0; color: #e1bee7; }
        
        .timestamp {
            color: #6e7681;
            font-size: 10px;
        }
        
        .message-type {
            font-weight: bold;
            margin-right: 8px;
        }
        
        .json-content {
            margin-top: 4px;
            padding: 4px 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 3px;
            font-size: 10px;
        }
        
        .clear-btn {
            background: #6f42c1;
            align-self: flex-end;
            margin-bottom: 10px;
        }
        
        .qr-section {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            border: 1px solid #3c3c3c;
        }
        
        .qr-code {
            text-align: center;
            margin: 10px 0;
        }
        
        .deeplink-input {
            width: 100%;
            margin-bottom: 10px;
            font-size: 10px;
            padding: 6px;
        }
        
        .auto-gps-indicator {
            color: #4caf50;
            font-size: 10px;
            font-weight: bold;
        }
        
        .location-status {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4caf50;
            border-radius: 4px;
            padding: 8px;
            margin: 8px 0;
            font-size: 11px;
        }
        
        .member-location {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 6px;
            margin: 4px 0;
            font-size: 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>ğŸ”Œ WebSocket ê°œë°œì í…ŒìŠ¤íŠ¸ ì½˜ì†”</h1>
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-indicator offline" id="loginStatus"></span>
                    <span id="loginText">ë¡œê·¸ì¸ í•„ìš”</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator offline" id="wsStatus"></span>
                    <span id="wsText">ì—°ê²° ì•ˆë¨</span>
                </div>
                <div class="status-item">
                    <span>Room:</span>
                    <span id="currentRoom">-</span>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- ì™¼ìª½: ì œì–´íŒ -->
            <div class="panel">
                <h2>âš™ï¸ ì œì–´íŒ</h2>
                
                <div class="control-group">
                    <label>ì¸ì¦</label>
                    <div class="btn-row">
                        <button onclick="goToLogin()" class="btn-small">ë¡œê·¸ì¸ í˜ì´ì§€</button>
                        <button onclick="logout()" class="btn-small">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>ë°© ê´€ë¦¬</label>
                    <div class="btn-row">
                        <button onclick="createRoom()" id="createBtn" disabled>ë°© ìƒì„± (User1)</button>
                    </div>
                    
                    <label style="margin-top: 10px;">ë”¥ë§í¬ë¡œ ë°© ì°¸ê°€</label>
                    <input type="text" id="deeplinkInput" placeholder="seafeet://join?code=ABC123&token=eyJ..." class="deeplink-input">
                    <button onclick="joinByDeeplink()" id="deeplinkBtn" disabled style="width: 100%;">ë”¥ë§í¬ ì—°ê²° (User2/3/4)</button>
                </div>
                
                <div class="qr-section" id="qrSection" style="display: none;">
                    <label>QR ì½”ë“œ (ê³µìœ ìš©)</label>
                    <div class="qr-code" id="qrCode"></div>
                    <input type="text" id="deeplinkDisplay" readonly style="width: 100%; font-size: 9px; margin-top: 5px;">
                    <button onclick="copyDeeplink()" class="btn-small" style="width: 100%; margin-top: 5px;">ë”¥ë§í¬ ë³µì‚¬</button>
                </div>

                <div class="control-group">
                    <label>ìœ„ì¹˜ í…ŒìŠ¤íŠ¸</label>
                    <div id="autoGpsStatus" class="auto-gps-indicator" style="display: none;">ğŸŸ¢ ìë™ GPS ì „ì†¡ ì¤‘ (5ì´ˆ ê°„ê²©)</div>
                    <div class="btn-row">
                        <button onclick="sendCurrentLocation()" id="gpsBtn" disabled class="btn-small">GPS</button>
                        <button onclick="startTracking()" id="trackBtn" disabled class="btn-small">ì¶”ì ì‹œì‘</button>
                        <button onclick="stopTracking()" id="stopBtn" disabled class="btn-small">ì¤‘ì§€</button>
                    </div>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        <input type="number" id="latInput" placeholder="ìœ„ë„" step="0.0001" style="flex: 1;">
                        <input type="number" id="lngInput" placeholder="ê²½ë„" step="0.0001" style="flex: 1;">
                    </div>
                    <button onclick="sendManualLocation()" id="manualBtn" disabled style="width: 100%; margin-top: 5px;">ìˆ˜ë™ ìœ„ì¹˜ ì „ì†¡</button>
                    
                    <div id="locationStatus" class="location-status" style="display: none;">
                        <div>ë‚´ ìœ„ì¹˜: <span id="myLocation">-</span></div>
                        <div>ë§ˆì§€ë§‰ ì „ì†¡: <span id="lastSent">-</span></div>
                    </div>
                    
                    <div id="memberLocations"></div>
                </div>

                <div class="control-group">
                    <label>í…ŒìŠ¤íŠ¸</label>
                    <div class="btn-row">
                        <button onclick="testDuplicate()" id="dupBtn" disabled class="btn-small">ì¤‘ë³µì—°ê²°</button>
                        <button onclick="testInvalidJti()" id="jtiBtn" disabled class="btn-small">ë¬´íš¨JTI</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>ì—°ê²° ì œì–´</label>
                    <button onclick="disconnectWs()" id="disconnectBtn" disabled style="width: 100%;">ì—°ê²° í•´ì œ</button>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ë©”ì‹œì§€ ë¡œê·¸ -->
            <div class="panel messages-panel">
                <h2>ğŸ“¡ WebSocket ë©”ì‹œì§€ ë¡œê·¸</h2>
                <button onclick="clearLog()" class="clear-btn btn-small">ë¡œê·¸ ì§€ìš°ê¸°</button>
                <div class="message-log" id="messageLog"></div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let stompClient = null;
        let currentRoom = null;
        let accessToken = null;
        let userInfo = null;
        let locationTracker = null;
        let currentJoinToken = null;
        let autoGpsInterval = null;
        let memberLocations = new Map();

        // ì´ˆê¸°í™”
        window.onload = function() {
            checkLoginStatus();
            setupEventListeners();
        };

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        function checkLoginStatus() {
            accessToken = localStorage.getItem('accessToken');
            const userInfoStr = localStorage.getItem('userInfo');
            
            if (accessToken && userInfoStr) {
                userInfo = JSON.parse(userInfoStr);
                updateLoginStatus(true);
                enableControls(true);
                logMessage('info', 'ë¡œê·¸ì¸ ìƒíƒœ', `ì‚¬ìš©ì: ${userInfo.nickname} (ID: ${userInfo.userId})`);
            } else {
                updateLoginStatus(false);
                enableControls(false);
                logMessage('error', 'ì¸ì¦ í•„ìš”', 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
            }
        }

        // ë¡œê·¸ì¸ ìƒíƒœ UI ì—…ë°ì´íŠ¸
        function updateLoginStatus(isLoggedIn) {
            const indicator = document.getElementById('loginStatus');
            const text = document.getElementById('loginText');
            
            if (isLoggedIn) {
                indicator.className = 'status-indicator online';
                text.textContent = userInfo.nickname;
            } else {
                indicator.className = 'status-indicator offline';
                text.textContent = 'ë¡œê·¸ì¸ í•„ìš”';
            }
        }

        // ì›¹ì†Œì¼“ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateWsStatus(connected) {
            const indicator = document.getElementById('wsStatus');
            const text = document.getElementById('wsText');
            
            if (connected) {
                indicator.className = 'status-indicator online';
                text.textContent = 'ì—°ê²°ë¨';
            } else {
                indicator.className = 'status-indicator offline';
                text.textContent = 'ì—°ê²° ì•ˆë¨';
            }
        }

        // ì»¨íŠ¸ë¡¤ í™œì„±í™”/ë¹„í™œì„±í™”
        function enableControls(enable) {
            document.getElementById('createBtn').disabled = !enable;
            document.getElementById('deeplinkBtn').disabled = !enable;
        }

        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        function goToLogin() {
            window.location.href = 'index.html';
        }

        // ë°© ìƒì„±
        async function createRoom() {
            if (!accessToken) return;

            try {
                logMessage('info', 'API ìš”ì²­', 'ë°© ìƒì„± ì¤‘...');
                
                const response = await fetch('http://localhost:8080/v1/location/rooms', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                logMessage('sub', 'API ì‘ë‹µ', JSON.stringify(data, null, 2));
                
                if (data.is_success) {
                    currentRoom = data.data;
                    document.getElementById('currentRoom').textContent = currentRoom.roomCode;
                    
                    // Join Token ì¶”ì¶œ
                    currentJoinToken = extractJoinToken(currentRoom.deepLink);
                    
                    logMessage('info', 'ë°© ìƒì„± ì„±ê³µ', `ì½”ë“œ: ${currentRoom.roomCode}`);
                    
                    // QR ì½”ë“œ ìƒì„± ë° í‘œì‹œ
                    showQRCode(currentRoom.deepLink);
                    
                    connectWebSocket(currentRoom.roomCode, currentRoom.roomId, currentJoinToken, true);
                } else {
                    logMessage('error', 'ë°© ìƒì„± ì‹¤íŒ¨', data.message);
                }
            } catch (error) {
                logMessage('error', 'ë°© ìƒì„± ì—ëŸ¬', error.message);
            }
        }


        // ë”¥ë§í¬ë¡œ ì§ì ‘ ì—°ê²°
        function joinByDeeplink() {
            const deeplink = document.getElementById('deeplinkInput').value.trim();
            if (!deeplink || !accessToken) return;
            
            try {
                logMessage('info', 'ë”¥ë§í¬ íŒŒì‹±', deeplink);
                
                // ë”¥ë§í¬ì—ì„œ roomCode, joinToken ì¶”ì¶œ
                const url = new URL(deeplink.replace('seafeet://', 'http://'));
                const roomCode = url.searchParams.get('code');
                const joinToken = url.searchParams.get('token');
                
                if (!roomCode || !joinToken) {
                    logMessage('error', 'ë”¥ë§í¬ ì˜¤ë¥˜', 'ë°©ì½”ë“œ ë˜ëŠ” í† í°ì´ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                currentRoom = {
                    roomCode: roomCode,
                    roomId: null, // ë”¥ë§í¬ì—ëŠ” roomId ì—†ìŒ
                    deepLink: deeplink
                };
                
                currentJoinToken = joinToken;
                document.getElementById('currentRoom').textContent = roomCode;
                
                logMessage('info', 'ë”¥ë§í¬ ì—°ê²°', `ë°©: ${roomCode}, í† í°: ${joinToken.substring(0,20)}...`);
                
                // QR ì½”ë“œ í‘œì‹œ
                showQRCode(deeplink);
                
                // ë°”ë¡œ ì›¹ì†Œì¼“ ì—°ê²° (API í˜¸ì¶œ ì—†ì´)
                connectWebSocket(roomCode, null, joinToken);
                
            } catch (error) {
                logMessage('error', 'ë”¥ë§í¬ ì—ëŸ¬', error.message);
            }
        }
        
        // ì›¹ì†Œì¼“ ì—°ê²°
        function connectWebSocket(roomCode, roomId, joinToken) {
            const wsUrl = `ws://localhost:8080/v1/ws`;
            logMessage('connect', 'WebSocket ì—°ê²°', `URL: ${wsUrl}`);
            
            const socket = new WebSocket(wsUrl);
            stompClient = Stomp.over(socket);
            stompClient.debug = null;
            
            const headers = {
                'Authorization': `Bearer ${accessToken}`,
                'room-code': roomCode,
                'join-token': joinToken || ''
            };
            
            logMessage('connect', 'STOMP CONNECT', JSON.stringify(headers, null, 2));
            
            stompClient.connect(headers, function(frame) {
                logMessage('connect', 'STOMP ì—°ê²° ì„±ê³µ', frame);
                updateWsStatus(true);
                
                // ì±„ë„ êµ¬ë…
                stompClient.subscribe(`/sub/location.${roomCode}`, function(message) {
                    const data = JSON.parse(message.body);
                    logMessage('sub', `SUB /sub/location.${roomCode}`, JSON.stringify(data, null, 2));
                    handleLocationUpdate(data);
                });
                
                stompClient.subscribe(`/user/sub/location.${roomCode}`, function(message) {
                    const data = JSON.parse(message.body);
                    logMessage('sub', `SUB /user/sub/location.${roomCode}`, JSON.stringify(data, null, 2));
                    handlePersonalMessage(data);
                });
                
                // JOIN ë©”ì‹œì§€ ì „ì†¡
                stompClient.send('/pub/location.join', {}, {});
                logMessage('pub', 'PUB /pub/location.join', '{}');
                
                enableLocationButtons(true);
                
                // ëª¨ë“  ì‚¬ìš©ì ìë™ GPS ì‹œì‘
                startAutoGPS();
                
            }, function(error) {
                logMessage('error', 'STOMP ì—°ê²° ì‹¤íŒ¨', error);
                updateWsStatus(false);
            });
        }

        // ìœ„ì¹˜ ë²„íŠ¼ í™œì„±í™”
        function enableLocationButtons(enable) {
            document.getElementById('gpsBtn').disabled = !enable;
            document.getElementById('trackBtn').disabled = !enable;
            document.getElementById('manualBtn').disabled = !enable;
            document.getElementById('dupBtn').disabled = !enable;
            document.getElementById('jtiBtn').disabled = !enable;
            document.getElementById('disconnectBtn').disabled = !enable;
        }

        // í˜„ì¬ ìœ„ì¹˜ ì „ì†¡
        function sendCurrentLocation() {
            if (!stompClient || !stompClient.connected) return;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const location = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: 5.0
                    };
                    
                    sendLocation(location);
                }, error => {
                    logMessage('error', 'GPS ì—ëŸ¬', error.message);
                });
            }
        }

        // ìˆ˜ë™ ìœ„ì¹˜ ì „ì†¡
        function sendManualLocation() {
            const lat = parseFloat(document.getElementById('latInput').value);
            const lng = parseFloat(document.getElementById('lngInput').value);
            
            if (isNaN(lat) || isNaN(lng)) return;
            
            const location = {
                latitude: lat,
                longitude: lng,
                accuracy: 5.0
            };
            
            sendLocation(location);
        }

        // ìœ„ì¹˜ ì „ì†¡
        function sendLocation(location) {
            if (stompClient && stompClient.connected) {
                stompClient.send('/pub/location.update', {}, JSON.stringify(location));
                logMessage('pub', 'PUB /pub/location.update', JSON.stringify(location, null, 2));
            }
        }

        // ì‹¤ì‹œê°„ ì¶”ì  ì‹œì‘
        function startTracking() {
            if (locationTracker) return;

            if (navigator.geolocation) {
                locationTracker = navigator.geolocation.watchPosition(position => {
                    const location = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: 5.0
                    };
                    
                    sendLocation(location);
                }, error => {
                    logMessage('error', 'ì¶”ì  ì—ëŸ¬', error.message);
                }, {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 5000
                });
                
                document.getElementById('trackBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                logMessage('info', 'ìœ„ì¹˜ ì¶”ì ', 'ì‹œì‘ë¨');
            }
        }

        // ì¶”ì  ì¤‘ì§€
        function stopTracking() {
            if (locationTracker) {
                navigator.geolocation.clearWatch(locationTracker);
                locationTracker = null;
                
                document.getElementById('trackBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                logMessage('info', 'ìœ„ì¹˜ ì¶”ì ', 'ì¤‘ì§€ë¨');
            }
        }

        // ì¤‘ë³µ ì—°ê²° í…ŒìŠ¤íŠ¸
        function testDuplicate() {
            if (!currentRoom || !currentJoinToken) return;

            logMessage('info', 'í…ŒìŠ¤íŠ¸', 'ì¤‘ë³µ ì—°ê²° ì‹œë„');
            
            const wsUrl = `ws://localhost:8080/v1/ws`;
            const testSocket = new WebSocket(wsUrl);
            const testClient = Stomp.over(testSocket);
            testClient.debug = null;
            
            const headers = {
                'Authorization': `Bearer ${accessToken}`,
                'room-code': currentRoom.roomCode,
                'join-token': currentJoinToken
            };
            
            testClient.connect(headers, 
                function(frame) {
                    logMessage('error', 'ì¤‘ë³µ ì—°ê²°', 'ì˜ˆìƒì¹˜ ëª»í•˜ê²Œ í—ˆìš©ë¨!');
                    testClient.disconnect();
                },
                function(error) {
                    logMessage('info', 'ì¤‘ë³µ ì—°ê²°', 'ì •ìƒì ìœ¼ë¡œ ì°¨ë‹¨ë¨');
                }
            );
        }

        // ë¬´íš¨ JTI í…ŒìŠ¤íŠ¸
        function testInvalidJti() {
            if (!currentRoom) return;

            const fakeJti = 'eyJhbGciOiJIUzI1NiJ9.fake_invalid_jwt.signature';
            
            logMessage('info', 'í…ŒìŠ¤íŠ¸', 'ë¬´íš¨ JTI ì—°ê²° ì‹œë„');
            
            const wsUrl = `ws://localhost:8080/v1/ws`;
            const testSocket = new WebSocket(wsUrl);
            const testClient = Stomp.over(testSocket);
            testClient.debug = null;
            
            const headers = {
                'Authorization': `Bearer ${accessToken}`,
                'room-code': currentRoom.roomCode,
                'join-token': fakeJti
            };
            
            testClient.connect(headers, 
                function(frame) {
                    logMessage('error', 'ë¬´íš¨ JTI', 'ì˜ˆìƒì¹˜ ëª»í•˜ê²Œ í—ˆìš©ë¨!');
                    testClient.disconnect();
                },
                function(error) {
                    logMessage('info', 'ë¬´íš¨ JTI', 'ì •ìƒì ìœ¼ë¡œ ì°¨ë‹¨ë¨');
                }
            );
        }

        // ì—°ê²° í•´ì œ
        function disconnectWs() {
            if (stompClient) {
                stompClient.disconnect();
                stompClient = null;
                updateWsStatus(false);
                enableLocationButtons(false);
                logMessage('connect', 'WebSocket ì—°ê²°', 'í•´ì œë¨');
            }
            
            if (locationTracker) {
                stopTracking();
            }
            
            // ìë™ GPS ì¤‘ì§€
            stopAutoGPS();
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            localStorage.clear();
            disconnectWs();
            
            userInfo = null;
            accessToken = null;
            currentRoom = null;
            
            updateLoginStatus(false);
            enableControls(false);
            document.getElementById('currentRoom').textContent = '-';
            
            logMessage('info', 'ë¡œê·¸ì•„ì›ƒ', 'ì™„ë£Œë¨');
        }

        // Join Token ì¶”ì¶œ
        function extractJoinToken(deepLink) {
            try {
                const url = new URL(deepLink.replace('seafeet://', 'http://'));
                const token = url.searchParams.get('token');
                if (token) {
                    logMessage('info', 'Join Token', 'ì¶”ì¶œ ì„±ê³µ');
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        logMessage('info', 'JWT ì •ë³´', `JTI: ${payload.jti}`);
                    } catch (e) {}
                    return token;
                }
            } catch (error) {
                logMessage('error', 'Join Token', 'ì¶”ì¶œ ì‹¤íŒ¨');
            }
            return null;
        }

        // ë¡œê·¸ ë©”ì‹œì§€ ì¶”ê°€
        function logMessage(type, category, content) {
            const log = document.getElementById('messageLog');
            const entry = document.createElement('div');
            entry.className = `message-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            const typeLabel = type.toUpperCase();
            
            entry.innerHTML = `<div><span class="timestamp">[${timestamp}]</span> <span class="message-type">${typeLabel}</span> <span>${category}</span></div><div class="json-content">${content}</div>`;
            
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // ë¡œê·¸ ì§€ìš°ê¸°
        function clearLog() {
            document.getElementById('messageLog').innerHTML = '';
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        function setupEventListeners() {
            document.getElementById('deeplinkInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !document.getElementById('deeplinkBtn').disabled) {
                    joinByDeeplink();
                }
            });
            
            ['latInput', 'lngInput'].forEach(id => {
                document.getElementById(id).addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !document.getElementById('manualBtn').disabled) {
                        sendManualLocation();
                    }
                });
            });
        }

        // ìë™ GPS ì „ì†¡ ì‹œì‘
        function startAutoGPS() {
            if (autoGpsInterval) return;
            
            autoGpsInterval = setInterval(() => {
                if (navigator.geolocation && stompClient && stompClient.connected) {
                    navigator.geolocation.getCurrentPosition(position => {
                        const location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: 5.0
                        };
                        
                        sendLocation(location);
                        updateMyLocation(location);
                        logMessage('info', 'ìë™ GPS', `${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`);
                    }, error => {
                        logMessage('error', 'ìë™ GPS ì—ëŸ¬', error.message);
                    });
                }
            }, 5000); // 5ì´ˆ ê°„ê²©
            
            document.getElementById('autoGpsStatus').style.display = 'block';
            logMessage('info', 'ìë™ GPS', 'ì‹œì‘ë¨ (5ì´ˆ ê°„ê²©)');
        }
        
        // ìë™ GPS ì¤‘ì§€
        function stopAutoGPS() {
            if (autoGpsInterval) {
                clearInterval(autoGpsInterval);
                autoGpsInterval = null;
                document.getElementById('autoGpsStatus').style.display = 'none';
                logMessage('info', 'ìë™ GPS', 'ì¤‘ì§€ë¨');
            }
        }
        
        // QR ì½”ë“œ ìƒì„± ë° í‘œì‹œ
        function showQRCode(deeplink) {
            const qrSection = document.getElementById('qrSection');
            const qrCode = document.getElementById('qrCode');
            const deeplinkDisplay = document.getElementById('deeplinkDisplay');
            
            // QR ì½”ë“œ ìƒì„±
            qrCode.innerHTML = '';
            const qr = new QRious({
                element: document.createElement('canvas'),
                value: deeplink,
                size: 150,
                background: 'white',
                foreground: 'black'
            });
            
            qrCode.appendChild(qr.canvas);
            deeplinkDisplay.value = deeplink;
            qrSection.style.display = 'block';
            
            logMessage('info', 'QR ìƒì„±', `í¬ê¸°: 150x150, ë”¥ë§í¬: ${deeplink.substring(0,50)}...`);
        }
        
        // ë”¥ë§í¬ ë³µì‚¬
        function copyDeeplink() {
            const deeplinkDisplay = document.getElementById('deeplinkDisplay');
            deeplinkDisplay.select();
            document.execCommand('copy');
            logMessage('info', 'ë”¥ë§í¬ ë³µì‚¬', 'í´ë¦½ë³´ë“œì— ë³µì‚¬ë¨');
        }
        
        // ë‚´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        function updateMyLocation(location) {
            document.getElementById('locationStatus').style.display = 'block';
            document.getElementById('myLocation').textContent = `${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`;
            document.getElementById('lastSent').textContent = new Date().toLocaleTimeString();
        }
        
        // ìˆ˜ì‹ ëœ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
        function handleLocationUpdate(data) {
            if (data.type === 'LOCATION_UPDATE' && data.data) {
                const userId = data.data.userId;
                const location = data.data;
                
                memberLocations.set(userId, {
                    userId: userId,
                    nickname: location.nickname || `User ${userId}`,
                    latitude: location.latitude,
                    longitude: location.longitude,
                    accuracy: location.accuracy,
                    timestamp: new Date().toLocaleTimeString()
                });
                
                updateMemberLocationsUI();
            }
        }
        
        // ê°œì¸ ë©”ì‹œì§€ ì²˜ë¦¬
        function handlePersonalMessage(data) {
            if (data.type === 'MEMBER_LIST' && data.data && data.data.members) {
                data.data.members.forEach(member => {
                    memberLocations.set(member.userId, {
                        userId: member.userId,
                        nickname: member.nickname,
                        latitude: member.latitude,
                        longitude: member.longitude,
                        accuracy: null,
                        timestamp: member.lastUpdateTime || '-'
                    });
                });
                updateMemberLocationsUI();
            }
        }
        
        // ë©¤ë²„ ìœ„ì¹˜ UI ì—…ë°ì´íŠ¸
        function updateMemberLocationsUI() {
            const container = document.getElementById('memberLocations');
            container.innerHTML = '';
            
            if (memberLocations.size === 0) return;
            
            memberLocations.forEach(member => {
                if (member.userId === userInfo?.userId) return; // ë³¸ì¸ ì œì™¸
                
                const div = document.createElement('div');
                div.className = 'member-location';
                div.innerHTML = `
                    <div style="font-weight: bold;">${member.nickname} (ID: ${member.userId})</div>
                    <div>ìœ„ì¹˜: ${member.latitude ? `${member.latitude.toFixed(6)}, ${member.longitude.toFixed(6)}` : 'ì—†ìŒ'}</div>
                    <div>ì—…ë°ì´íŠ¸: ${member.timestamp}</div>
                `;
                container.appendChild(div);
            });
        }
        
        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì •ë¦¬
        window.onbeforeunload = function() {
            stopAutoGPS();
            disconnectWs();
        };
    </script>
</body>
</html>