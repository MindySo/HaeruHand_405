<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket 개발자 테스트</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            line-height: 1.4;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: #2d2d30;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #3c3c3c;
        }
        
        .header h1 {
            font-size: 18px;
            color: #4fc1ff;
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 12px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-indicator.online { background: #4caf50; }
        .status-indicator.offline { background: #f44336; }
        
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100vh - 140px);
        }
        
        .panel {
            background: #2d2d30;
            border-radius: 6px;
            padding: 15px;
            border: 1px solid #3c3c3c;
            display: flex;
            flex-direction: column;
        }
        
        .panel h2 {
            font-size: 14px;
            color: #4fc1ff;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #3c3c3c;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            font-size: 11px;
            color: #9cdcfe;
            margin-bottom: 5px;
        }
        
        input, button {
            padding: 8px;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            font-family: inherit;
            font-size: 12px;
        }
        
        input {
            background: #1e1e1e;
            color: #d4d4d4;
            width: 100%;
        }
        
        input:focus {
            outline: none;
            border-color: #007acc;
        }
        
        button {
            background: #0e639c;
            color: white;
            cursor: pointer;
            border: none;
            margin: 2px;
        }
        
        button:hover:not(:disabled) {
            background: #1177bb;
        }
        
        button:disabled {
            background: #3c3c3c;
            color: #808080;
            cursor: not-allowed;
        }
        
        .btn-row {
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 6px 10px;
            font-size: 11px;
        }
        
        .messages-panel {
            display: flex;
            flex-direction: column;
        }
        
        .message-log {
            flex: 1;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Consolas', monospace;
            font-size: 11px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .message-entry {
            margin-bottom: 8px;
            padding: 4px;
            border-left: 3px solid transparent;
        }
        
        .message-entry.pub { border-left-color: #ffa500; color: #ffcc99; }
        .message-entry.sub { border-left-color: #4caf50; color: #c8e6c9; }
        .message-entry.connect { border-left-color: #2196f3; color: #bbdefb; }
        .message-entry.error { border-left-color: #f44336; color: #ffcdd2; }
        .message-entry.info { border-left-color: #9c27b0; color: #e1bee7; }
        
        .timestamp {
            color: #6e7681;
            font-size: 10px;
        }
        
        .message-type {
            font-weight: bold;
            margin-right: 8px;
        }
        
        .json-content {
            margin-top: 4px;
            padding: 4px 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 3px;
            font-size: 10px;
        }
        
        .clear-btn {
            background: #6f42c1;
            align-self: flex-end;
            margin-bottom: 10px;
        }
        
        .qr-section {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            border: 1px solid #3c3c3c;
        }
        
        .qr-code {
            text-align: center;
            margin: 10px 0;
        }
        
        .deeplink-input {
            width: 100%;
            margin-bottom: 10px;
            font-size: 10px;
            padding: 6px;
        }
        
        .auto-gps-indicator {
            color: #4caf50;
            font-size: 10px;
            font-weight: bold;
        }
        
        .location-status {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4caf50;
            border-radius: 4px;
            padding: 8px;
            margin: 8px 0;
            font-size: 11px;
        }
        
        .member-location {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 6px;
            margin: 4px 0;
            font-size: 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <h1>🔌 WebSocket 개발자 테스트 콘솔</h1>
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-indicator offline" id="loginStatus"></span>
                    <span id="loginText">로그인 필요</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator offline" id="wsStatus"></span>
                    <span id="wsText">연결 안됨</span>
                </div>
                <div class="status-item">
                    <span>Room:</span>
                    <span id="currentRoom">-</span>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- 왼쪽: 제어판 -->
            <div class="panel">
                <h2>⚙️ 제어판</h2>
                
                <div class="control-group">
                    <label>인증</label>
                    <div class="btn-row">
                        <button onclick="goToLogin()" class="btn-small">로그인 페이지</button>
                        <button onclick="logout()" class="btn-small">로그아웃</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>방 관리</label>
                    <div class="btn-row">
                        <button onclick="createRoom()" id="createBtn" disabled>방 생성 (User1)</button>
                    </div>
                    
                    <label style="margin-top: 10px;">딥링크로 방 참가</label>
                    <input type="text" id="deeplinkInput" placeholder="seafeet://join?code=ABC123&token=eyJ..." class="deeplink-input">
                    <button onclick="joinByDeeplink()" id="deeplinkBtn" disabled style="width: 100%;">딥링크 연결 (User2/3/4)</button>
                </div>
                
                <div class="qr-section" id="qrSection" style="display: none;">
                    <label>QR 코드 (공유용)</label>
                    <div class="qr-code" id="qrCode"></div>
                    <input type="text" id="deeplinkDisplay" readonly style="width: 100%; font-size: 9px; margin-top: 5px;">
                    <button onclick="copyDeeplink()" class="btn-small" style="width: 100%; margin-top: 5px;">딥링크 복사</button>
                </div>

                <div class="control-group">
                    <label>위치 테스트</label>
                    <div id="autoGpsStatus" class="auto-gps-indicator" style="display: none;">🟢 자동 GPS 전송 중 (5초 간격)</div>
                    <div class="btn-row">
                        <button onclick="sendCurrentLocation()" id="gpsBtn" disabled class="btn-small">GPS</button>
                        <button onclick="startTracking()" id="trackBtn" disabled class="btn-small">추적시작</button>
                        <button onclick="stopTracking()" id="stopBtn" disabled class="btn-small">중지</button>
                    </div>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        <input type="number" id="latInput" placeholder="위도" step="0.0001" style="flex: 1;">
                        <input type="number" id="lngInput" placeholder="경도" step="0.0001" style="flex: 1;">
                    </div>
                    <button onclick="sendManualLocation()" id="manualBtn" disabled style="width: 100%; margin-top: 5px;">수동 위치 전송</button>
                    
                    <div id="locationStatus" class="location-status" style="display: none;">
                        <div>내 위치: <span id="myLocation">-</span></div>
                        <div>마지막 전송: <span id="lastSent">-</span></div>
                    </div>
                    
                    <div id="memberLocations"></div>
                </div>

                <div class="control-group">
                    <label>테스트</label>
                    <div class="btn-row">
                        <button onclick="testDuplicate()" id="dupBtn" disabled class="btn-small">중복연결</button>
                        <button onclick="testInvalidJti()" id="jtiBtn" disabled class="btn-small">무효JTI</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>연결 제어</label>
                    <button onclick="disconnectWs()" id="disconnectBtn" disabled style="width: 100%;">연결 해제</button>
                </div>
            </div>

            <!-- 오른쪽: 메시지 로그 -->
            <div class="panel messages-panel">
                <h2>📡 WebSocket 메시지 로그</h2>
                <button onclick="clearLog()" class="clear-btn btn-small">로그 지우기</button>
                <div class="message-log" id="messageLog"></div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let stompClient = null;
        let currentRoom = null;
        let accessToken = null;
        let userInfo = null;
        let locationTracker = null;
        let currentJoinToken = null;
        let autoGpsInterval = null;
        let memberLocations = new Map();

        // 초기화
        window.onload = function() {
            checkLoginStatus();
            setupEventListeners();
        };

        // 로그인 상태 확인
        function checkLoginStatus() {
            accessToken = localStorage.getItem('accessToken');
            const userInfoStr = localStorage.getItem('userInfo');
            
            if (accessToken && userInfoStr) {
                userInfo = JSON.parse(userInfoStr);
                updateLoginStatus(true);
                enableControls(true);
                logMessage('info', '로그인 상태', `사용자: ${userInfo.nickname} (ID: ${userInfo.userId})`);
            } else {
                updateLoginStatus(false);
                enableControls(false);
                logMessage('error', '인증 필요', '로그인이 필요합니다');
            }
        }

        // 로그인 상태 UI 업데이트
        function updateLoginStatus(isLoggedIn) {
            const indicator = document.getElementById('loginStatus');
            const text = document.getElementById('loginText');
            
            if (isLoggedIn) {
                indicator.className = 'status-indicator online';
                text.textContent = userInfo.nickname;
            } else {
                indicator.className = 'status-indicator offline';
                text.textContent = '로그인 필요';
            }
        }

        // 웹소켓 상태 업데이트
        function updateWsStatus(connected) {
            const indicator = document.getElementById('wsStatus');
            const text = document.getElementById('wsText');
            
            if (connected) {
                indicator.className = 'status-indicator online';
                text.textContent = '연결됨';
            } else {
                indicator.className = 'status-indicator offline';
                text.textContent = '연결 안됨';
            }
        }

        // 컨트롤 활성화/비활성화
        function enableControls(enable) {
            document.getElementById('createBtn').disabled = !enable;
            document.getElementById('deeplinkBtn').disabled = !enable;
        }

        // 로그인 페이지로 이동
        function goToLogin() {
            window.location.href = 'index.html';
        }

        // 방 생성
        async function createRoom() {
            if (!accessToken) return;

            try {
                logMessage('info', 'API 요청', '방 생성 중...');
                
                const response = await fetch('http://localhost:8080/v1/location/rooms', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                logMessage('sub', 'API 응답', JSON.stringify(data, null, 2));
                
                if (data.is_success) {
                    currentRoom = data.data;
                    document.getElementById('currentRoom').textContent = currentRoom.roomCode;
                    
                    // Join Token 추출
                    currentJoinToken = extractJoinToken(currentRoom.deepLink);
                    
                    logMessage('info', '방 생성 성공', `코드: ${currentRoom.roomCode}`);
                    
                    // QR 코드 생성 및 표시
                    showQRCode(currentRoom.deepLink);
                    
                    connectWebSocket(currentRoom.roomCode, currentRoom.roomId, currentJoinToken, true);
                } else {
                    logMessage('error', '방 생성 실패', data.message);
                }
            } catch (error) {
                logMessage('error', '방 생성 에러', error.message);
            }
        }


        // 딥링크로 직접 연결
        function joinByDeeplink() {
            const deeplink = document.getElementById('deeplinkInput').value.trim();
            if (!deeplink || !accessToken) return;
            
            try {
                logMessage('info', '딥링크 파싱', deeplink);
                
                // 딥링크에서 roomCode, joinToken 추출
                const url = new URL(deeplink.replace('seafeet://', 'http://'));
                const roomCode = url.searchParams.get('code');
                const joinToken = url.searchParams.get('token');
                
                if (!roomCode || !joinToken) {
                    logMessage('error', '딥링크 오류', '방코드 또는 토큰이 없습니다');
                    return;
                }
                
                currentRoom = {
                    roomCode: roomCode,
                    roomId: null, // 딥링크에는 roomId 없음
                    deepLink: deeplink
                };
                
                currentJoinToken = joinToken;
                document.getElementById('currentRoom').textContent = roomCode;
                
                logMessage('info', '딥링크 연결', `방: ${roomCode}, 토큰: ${joinToken.substring(0,20)}...`);
                
                // QR 코드 표시
                showQRCode(deeplink);
                
                // 바로 웹소켓 연결 (API 호출 없이)
                connectWebSocket(roomCode, null, joinToken);
                
            } catch (error) {
                logMessage('error', '딥링크 에러', error.message);
            }
        }
        
        // 웹소켓 연결
        function connectWebSocket(roomCode, roomId, joinToken) {
            const wsUrl = `ws://localhost:8080/v1/ws`;
            logMessage('connect', 'WebSocket 연결', `URL: ${wsUrl}`);
            
            const socket = new WebSocket(wsUrl);
            stompClient = Stomp.over(socket);
            stompClient.debug = null;
            
            const headers = {
                'Authorization': `Bearer ${accessToken}`,
                'room-code': roomCode,
                'join-token': joinToken || ''
            };
            
            logMessage('connect', 'STOMP CONNECT', JSON.stringify(headers, null, 2));
            
            stompClient.connect(headers, function(frame) {
                logMessage('connect', 'STOMP 연결 성공', frame);
                updateWsStatus(true);
                
                // 채널 구독
                stompClient.subscribe(`/sub/location.${roomCode}`, function(message) {
                    const data = JSON.parse(message.body);
                    logMessage('sub', `SUB /sub/location.${roomCode}`, JSON.stringify(data, null, 2));
                    handleLocationUpdate(data);
                });
                
                stompClient.subscribe(`/user/sub/location.${roomCode}`, function(message) {
                    const data = JSON.parse(message.body);
                    logMessage('sub', `SUB /user/sub/location.${roomCode}`, JSON.stringify(data, null, 2));
                    handlePersonalMessage(data);
                });
                
                // JOIN 메시지 전송
                stompClient.send('/pub/location.join', {}, {});
                logMessage('pub', 'PUB /pub/location.join', '{}');
                
                enableLocationButtons(true);
                
                // 모든 사용자 자동 GPS 시작
                startAutoGPS();
                
            }, function(error) {
                logMessage('error', 'STOMP 연결 실패', error);
                updateWsStatus(false);
            });
        }

        // 위치 버튼 활성화
        function enableLocationButtons(enable) {
            document.getElementById('gpsBtn').disabled = !enable;
            document.getElementById('trackBtn').disabled = !enable;
            document.getElementById('manualBtn').disabled = !enable;
            document.getElementById('dupBtn').disabled = !enable;
            document.getElementById('jtiBtn').disabled = !enable;
            document.getElementById('disconnectBtn').disabled = !enable;
        }

        // 현재 위치 전송
        function sendCurrentLocation() {
            if (!stompClient || !stompClient.connected) return;

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const location = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: 5.0
                    };
                    
                    sendLocation(location);
                }, error => {
                    logMessage('error', 'GPS 에러', error.message);
                });
            }
        }

        // 수동 위치 전송
        function sendManualLocation() {
            const lat = parseFloat(document.getElementById('latInput').value);
            const lng = parseFloat(document.getElementById('lngInput').value);
            
            if (isNaN(lat) || isNaN(lng)) return;
            
            const location = {
                latitude: lat,
                longitude: lng,
                accuracy: 5.0
            };
            
            sendLocation(location);
        }

        // 위치 전송
        function sendLocation(location) {
            if (stompClient && stompClient.connected) {
                stompClient.send('/pub/location.update', {}, JSON.stringify(location));
                logMessage('pub', 'PUB /pub/location.update', JSON.stringify(location, null, 2));
            }
        }

        // 실시간 추적 시작
        function startTracking() {
            if (locationTracker) return;

            if (navigator.geolocation) {
                locationTracker = navigator.geolocation.watchPosition(position => {
                    const location = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: 5.0
                    };
                    
                    sendLocation(location);
                }, error => {
                    logMessage('error', '추적 에러', error.message);
                }, {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 5000
                });
                
                document.getElementById('trackBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                logMessage('info', '위치 추적', '시작됨');
            }
        }

        // 추적 중지
        function stopTracking() {
            if (locationTracker) {
                navigator.geolocation.clearWatch(locationTracker);
                locationTracker = null;
                
                document.getElementById('trackBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                logMessage('info', '위치 추적', '중지됨');
            }
        }

        // 중복 연결 테스트
        function testDuplicate() {
            if (!currentRoom || !currentJoinToken) return;

            logMessage('info', '테스트', '중복 연결 시도');
            
            const wsUrl = `ws://localhost:8080/v1/ws`;
            const testSocket = new WebSocket(wsUrl);
            const testClient = Stomp.over(testSocket);
            testClient.debug = null;
            
            const headers = {
                'Authorization': `Bearer ${accessToken}`,
                'room-code': currentRoom.roomCode,
                'join-token': currentJoinToken
            };
            
            testClient.connect(headers, 
                function(frame) {
                    logMessage('error', '중복 연결', '예상치 못하게 허용됨!');
                    testClient.disconnect();
                },
                function(error) {
                    logMessage('info', '중복 연결', '정상적으로 차단됨');
                }
            );
        }

        // 무효 JTI 테스트
        function testInvalidJti() {
            if (!currentRoom) return;

            const fakeJti = 'eyJhbGciOiJIUzI1NiJ9.fake_invalid_jwt.signature';
            
            logMessage('info', '테스트', '무효 JTI 연결 시도');
            
            const wsUrl = `ws://localhost:8080/v1/ws`;
            const testSocket = new WebSocket(wsUrl);
            const testClient = Stomp.over(testSocket);
            testClient.debug = null;
            
            const headers = {
                'Authorization': `Bearer ${accessToken}`,
                'room-code': currentRoom.roomCode,
                'join-token': fakeJti
            };
            
            testClient.connect(headers, 
                function(frame) {
                    logMessage('error', '무효 JTI', '예상치 못하게 허용됨!');
                    testClient.disconnect();
                },
                function(error) {
                    logMessage('info', '무효 JTI', '정상적으로 차단됨');
                }
            );
        }

        // 연결 해제
        function disconnectWs() {
            if (stompClient) {
                stompClient.disconnect();
                stompClient = null;
                updateWsStatus(false);
                enableLocationButtons(false);
                logMessage('connect', 'WebSocket 연결', '해제됨');
            }
            
            if (locationTracker) {
                stopTracking();
            }
            
            // 자동 GPS 중지
            stopAutoGPS();
        }

        // 로그아웃
        function logout() {
            localStorage.clear();
            disconnectWs();
            
            userInfo = null;
            accessToken = null;
            currentRoom = null;
            
            updateLoginStatus(false);
            enableControls(false);
            document.getElementById('currentRoom').textContent = '-';
            
            logMessage('info', '로그아웃', '완료됨');
        }

        // Join Token 추출
        function extractJoinToken(deepLink) {
            try {
                const url = new URL(deepLink.replace('seafeet://', 'http://'));
                const token = url.searchParams.get('token');
                if (token) {
                    logMessage('info', 'Join Token', '추출 성공');
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        logMessage('info', 'JWT 정보', `JTI: ${payload.jti}`);
                    } catch (e) {}
                    return token;
                }
            } catch (error) {
                logMessage('error', 'Join Token', '추출 실패');
            }
            return null;
        }

        // 로그 메시지 추가
        function logMessage(type, category, content) {
            const log = document.getElementById('messageLog');
            const entry = document.createElement('div');
            entry.className = `message-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            const typeLabel = type.toUpperCase();
            
            entry.innerHTML = `<div><span class="timestamp">[${timestamp}]</span> <span class="message-type">${typeLabel}</span> <span>${category}</span></div><div class="json-content">${content}</div>`;
            
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // 로그 지우기
        function clearLog() {
            document.getElementById('messageLog').innerHTML = '';
        }

        // 이벤트 리스너
        function setupEventListeners() {
            document.getElementById('deeplinkInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !document.getElementById('deeplinkBtn').disabled) {
                    joinByDeeplink();
                }
            });
            
            ['latInput', 'lngInput'].forEach(id => {
                document.getElementById(id).addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !document.getElementById('manualBtn').disabled) {
                        sendManualLocation();
                    }
                });
            });
        }

        // 자동 GPS 전송 시작
        function startAutoGPS() {
            if (autoGpsInterval) return;
            
            autoGpsInterval = setInterval(() => {
                if (navigator.geolocation && stompClient && stompClient.connected) {
                    navigator.geolocation.getCurrentPosition(position => {
                        const location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: 5.0
                        };
                        
                        sendLocation(location);
                        updateMyLocation(location);
                        logMessage('info', '자동 GPS', `${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`);
                    }, error => {
                        logMessage('error', '자동 GPS 에러', error.message);
                    });
                }
            }, 5000); // 5초 간격
            
            document.getElementById('autoGpsStatus').style.display = 'block';
            logMessage('info', '자동 GPS', '시작됨 (5초 간격)');
        }
        
        // 자동 GPS 중지
        function stopAutoGPS() {
            if (autoGpsInterval) {
                clearInterval(autoGpsInterval);
                autoGpsInterval = null;
                document.getElementById('autoGpsStatus').style.display = 'none';
                logMessage('info', '자동 GPS', '중지됨');
            }
        }
        
        // QR 코드 생성 및 표시
        function showQRCode(deeplink) {
            const qrSection = document.getElementById('qrSection');
            const qrCode = document.getElementById('qrCode');
            const deeplinkDisplay = document.getElementById('deeplinkDisplay');
            
            // QR 코드 생성
            qrCode.innerHTML = '';
            const qr = new QRious({
                element: document.createElement('canvas'),
                value: deeplink,
                size: 150,
                background: 'white',
                foreground: 'black'
            });
            
            qrCode.appendChild(qr.canvas);
            deeplinkDisplay.value = deeplink;
            qrSection.style.display = 'block';
            
            logMessage('info', 'QR 생성', `크기: 150x150, 딥링크: ${deeplink.substring(0,50)}...`);
        }
        
        // 딥링크 복사
        function copyDeeplink() {
            const deeplinkDisplay = document.getElementById('deeplinkDisplay');
            deeplinkDisplay.select();
            document.execCommand('copy');
            logMessage('info', '딥링크 복사', '클립보드에 복사됨');
        }
        
        // 내 위치 업데이트
        function updateMyLocation(location) {
            document.getElementById('locationStatus').style.display = 'block';
            document.getElementById('myLocation').textContent = `${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`;
            document.getElementById('lastSent').textContent = new Date().toLocaleTimeString();
        }
        
        // 수신된 위치 업데이트 처리
        function handleLocationUpdate(data) {
            if (data.type === 'LOCATION_UPDATE' && data.data) {
                const userId = data.data.userId;
                const location = data.data;
                
                memberLocations.set(userId, {
                    userId: userId,
                    nickname: location.nickname || `User ${userId}`,
                    latitude: location.latitude,
                    longitude: location.longitude,
                    accuracy: location.accuracy,
                    timestamp: new Date().toLocaleTimeString()
                });
                
                updateMemberLocationsUI();
            }
        }
        
        // 개인 메시지 처리
        function handlePersonalMessage(data) {
            if (data.type === 'MEMBER_LIST' && data.data && data.data.members) {
                data.data.members.forEach(member => {
                    memberLocations.set(member.userId, {
                        userId: member.userId,
                        nickname: member.nickname,
                        latitude: member.latitude,
                        longitude: member.longitude,
                        accuracy: null,
                        timestamp: member.lastUpdateTime || '-'
                    });
                });
                updateMemberLocationsUI();
            }
        }
        
        // 멤버 위치 UI 업데이트
        function updateMemberLocationsUI() {
            const container = document.getElementById('memberLocations');
            container.innerHTML = '';
            
            if (memberLocations.size === 0) return;
            
            memberLocations.forEach(member => {
                if (member.userId === userInfo?.userId) return; // 본인 제외
                
                const div = document.createElement('div');
                div.className = 'member-location';
                div.innerHTML = `
                    <div style="font-weight: bold;">${member.nickname} (ID: ${member.userId})</div>
                    <div>위치: ${member.latitude ? `${member.latitude.toFixed(6)}, ${member.longitude.toFixed(6)}` : '없음'}</div>
                    <div>업데이트: ${member.timestamp}</div>
                `;
                container.appendChild(div);
            });
        }
        
        // 페이지 종료 시 정리
        window.onbeforeunload = function() {
            stopAutoGPS();
            disconnectWs();
        };
    </script>
</body>
</html>